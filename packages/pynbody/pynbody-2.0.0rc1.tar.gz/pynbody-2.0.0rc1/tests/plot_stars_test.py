import numpy.testing as npt
import pytest

import pynbody
import pynbody.test_utils


@pytest.fixture(scope='module', autouse=True)
def get_data():
    pynbody.test_utils.ensure_test_data_available("gasoline_ahf")

@pytest.fixture(scope='module')
def snap_and_halos():
    f = pynbody.load("testdata/gasoline_ahf/g15784.lr.01024")
    h = f.halos()
    return f, h

@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sb_profile(snap_and_halos):
    f, h = snap_and_halos
    r, sb, scale, norm = pynbody.plot.stars.sbprofile(h[0], fit_exp=0.5, rmax="10 kpc")

    r0 = [0.0874619 , 0.20368062, 0.26738311, 0.31767552, 0.36108518,
           0.40084337, 0.4383984 , 0.47336635, 0.5059734 , 0.53761647,
           0.56817074, 0.59795851, 0.62674851, 0.65396184, 0.68058308,
           0.7070974 , 0.73298874, 0.75822741, 0.78369301, 0.80941218,
           0.83507683, 0.86103971, 0.88669897, 0.91177024, 0.93724434,
           0.96313534, 0.98817425, 1.01313758, 1.03911239, 1.06525488,
           1.09185537, 1.11933993, 1.14695887, 1.17488616, 1.20368003,
           1.23260616, 1.26163336, 1.29137896, 1.32162412, 1.35234996,
           1.38408684, 1.41684587, 1.44993651, 1.48451027, 1.5201146 ,
           1.55552695, 1.5921524 , 1.62962405, 1.66863183, 1.70951462,
           1.75156766, 1.79610374, 1.84239187, 1.88925884, 1.93740968,
           1.98678067, 2.03923895, 2.09417266, 2.15076523, 2.20954141,
           2.26995829, 2.33221602, 2.39804029, 2.46568462, 2.5343678 ,
           2.60702061, 2.68318259, 2.76228278, 2.84406344, 2.92901073,
           3.01747621, 3.11133564, 3.21078164, 3.31458753, 3.42435416,
           3.53681497, 3.6526486 , 3.77713534, 3.90885082, 4.04973645,
           4.20157217, 4.35771223, 4.51605302, 4.68337016, 4.85789164,
           5.0384083 , 5.22711524, 5.42946145, 5.64534063, 5.87276146,
           6.10884874, 6.36566983, 6.64798635, 6.95208341, 7.28470793,
           7.63983852, 8.02516699, 8.46691225, 9.00212771, 9.64897665]
    sb0 = [17.42209862, 17.53392953, 17.36624371, 17.20291844, 17.52693797,
           17.4384243 , 17.58974392, 17.45621955, 17.62416351, 17.54090965,
           17.64435192, 17.75072278, 17.52712054, 17.82126944, 17.68134677,
           17.86053269, 17.7216456 , 17.79882271, 18.1684325 , 17.97049235,
           18.08487144, 17.99570875, 18.09289317, 18.16665361, 18.38394454,
           18.31789086, 18.30128998, 18.18737042, 18.45646377, 18.3596519 ,
           18.60609601, 18.65488386, 18.66979987, 18.60010325, 18.80285006,
           18.81473955, 18.97286205, 18.96050509, 18.99469159, 19.05438387,
           19.17370006, 19.24591682, 19.300474  , 19.37560898, 19.33592699,
           19.50457673, 19.38307963, 19.56529968, 19.7376015 , 19.72987976,
           19.93853926, 19.98867885, 20.01643974, 20.00104802, 20.05052263,
           20.08475379, 20.24973762, 20.26651645, 20.11669296, 20.42300587,
           20.51466173, 20.49056194, 20.53160175, 20.53974688, 20.63623498,
           20.49279124, 20.74621102, 20.78476997, 20.79672233, 20.86854985,
           20.88411352, 21.066555  , 20.88447906, 21.02670464, 21.26886843,
           21.2322897 , 21.45618318, 21.38354195, 21.60178467, 21.66006192,
           21.79795208, 21.45032737, 21.76055778, 21.89892331, 21.86415926,
           21.69230811, 21.7376724 , 22.14316607, 22.16319607, 22.24134472,
           22.15274538, 22.3361127 , 22.25593221, 22.66165943, 22.65959801,
           22.68331129, 22.64411064, 23.32178214, 23.55109494, 24.16447312]
    scale0 = 1.5363742476226192
    norm0 = 18.123342900680715

    npt.assert_allclose(r, r0, rtol=1e-7)
    npt.assert_allclose(sb, sb0, rtol=1e-7)
    npt.assert_allclose(scale, scale0, rtol=1e-7)
    npt.assert_allclose(norm, norm0, rtol=1e-7)

@pytest.mark.filterwarnings("ignore:No log file found:UserWarning")
def test_sfh(snap_and_halos):
    f, h = snap_and_halos
    t, sfh = pynbody.plot.stars.sfh(h[0])

    t0 = [ 0.23160894,  0.36657633,  0.50154373,  0.63651112,  0.77147851,
           0.9064459 ,  1.04141329,  1.17638068,  1.31134807,  1.44631546,
           1.58128285,  1.71625024,  1.85121763,  1.98618502,  2.12115241,
           2.25611981,  2.3910872 ,  2.52605459,  2.66102198,  2.79598937,
           2.93095676,  3.06592415,  3.20089154,  3.33585893,  3.47082632,
           3.60579371,  3.7407611 ,  3.8757285 ,  4.01069589,  4.14566328,
           4.28063067,  4.41559806,  4.55056545,  4.68553284,  4.82050023,
           4.95546762,  5.09043501,  5.2254024 ,  5.36036979,  5.49533718,
           5.63030458,  5.76527197,  5.90023936,  6.03520675,  6.17017414,
           6.30514153,  6.44010892,  6.57507631,  6.7100437 ,  6.84501109,
           6.97997848,  7.11494587,  7.24991326,  7.38488066,  7.51984805,
           7.65481544,  7.78978283,  7.92475022,  8.05971761,  8.194685  ,
           8.32965239,  8.46461978,  8.59958717,  8.73455456,  8.86952195,
           9.00448935,  9.13945674,  9.27442413,  9.40939152,  9.54435891,
           9.6793263 ,  9.81429369,  9.94926108, 10.08422847, 10.21919586,
          10.35416325, 10.48913064, 10.62409803, 10.75906543, 10.89403282,
          11.02900021, 11.1639676 , 11.29893499, 11.43390238, 11.56886977,
          11.70383716, 11.83880455, 11.97377194, 12.10873933, 12.24370672,
          12.37867412, 12.51364151, 12.6486089 , 12.78357629, 12.91854368,
          13.05351107, 13.18847846, 13.32344585, 13.45841324, 13.59338063,
          13.72834802]

    sfh0 = [ 0.35855347,  1.56101938,  3.4456114 ,  5.32119741, 15.19657074,
          21.22159318, 30.07963412, 43.70868589, 47.28474849, 42.75664328,
          52.92601364, 62.54722538, 46.71281852, 52.67547379, 41.99851596,
          30.39877028, 28.04710316, 28.90193334, 27.98081876, 26.34093023,
          24.81153507, 21.75968903, 20.0778341 , 19.11956184, 17.9305885 ,
          16.6756488 , 17.96513369, 15.78863045, 12.36869897, 11.55602824,
          11.47672118, 10.2917112 ,  9.70704   ,  9.71972978, 10.27028945,
           9.74930048,  9.36958484,  8.53044963,  8.66610515,  8.51290009,
           8.54317933,  8.25448224,  7.86579607,  7.39748441,  7.15336397,
           6.89119156,  6.53635068,  6.78163586,  6.36162173,  6.18236408,
           5.74970147,  5.46508479,  5.73229865,  5.58381441,  5.44771686,
           5.10256262,  4.80111842,  4.93139337,  5.52204463,  5.02788058,
           4.40733215,  4.21518958,  4.1403365 ,  4.4552328 ,  4.11007103,
           4.03525989,  3.56364822,  3.68580178,  4.06211697,  3.69896696,
           3.47161382,  3.81267958,  3.57678949,  3.30952793,  3.49371003,
           3.30099964,  3.12186234,  3.15215854,  3.24447164,  3.26196206,
           3.11306531,  2.98182771,  3.04333189,  2.98204232,  3.20074561,
           3.07375322,  2.98641521,  2.824613  ,  2.74526299,  3.19163668,
           2.92078668,  3.08228986,  3.12615621,  3.33629631,  3.36681181,
           3.37122513,  3.33166896,  3.39289043,  3.49792132,  3.42365663]

    npt.assert_allclose(t, t0, atol=1e-5)
    npt.assert_allclose(sfh, sfh0, atol=1e-5)
