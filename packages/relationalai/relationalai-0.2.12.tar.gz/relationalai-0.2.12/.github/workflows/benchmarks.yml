name: Run Benchmarks

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

concurrency:
  group:
    ${{ github.workflow }}-${{ (github.ref_name == 'main' || github.event_name == 'workflow_dispatch')
    && github.run_id
    || github.ref }}
  cancel-in-progress: true 

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: '3.12'
            cloud-provider: 'snowflake'
    steps:

    - uses: actions/checkout@v4
      name: Checkout repository

    - uses: ./.github/actions/benchmarks
      id: run_benchmarks
      with:
        python_version: ${{ matrix.python-version }}
        rai_cloud_provider: ${{ matrix.cloud-provider }}
        rai_client_id: ${{ secrets.RAI_CLIENT_ID }}
        rai_client_secret: ${{ secrets.RAI_CLIENT_SECRET }}
        sf_account: ndsoebe-rai_integration_aws_uswest_1_consumer
        sf_warehouse: int_env_wh
        sf_rai_app_name: rai_int_app
        sf_compute_pool: INT_ENV_BENCHMARK_COMPUTE_M
        sf_username: team-prod-experience@relational.ai
        sf_password: ${{ secrets.SF_TEST_ACCOUNT_PASSWORD }}
        datadog_api_key: ${{ secrets.DD_API_KEY }}
        sf_reporting_password: ${{ secrets.SF_REPORTING_PASSWORD }}
    
    - name: Upload Coverage Artifact
      uses: actions/upload-artifact@v2
      with:
        name: coverage-artifact-${{ matrix.python-version }}
        path: coverage/lcov.info

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v2
      with:
        name: coverage-report-${{ matrix.python-version }}
        path: coverage/html-report
    
    - name: Post to Slack
      # if the run_benchmarks step failed
      if: ${{ failure() }}
      uses: slackapi/slack-github-action@v1.23.0
      with:
        channel-id: C066T0HBSTW # team-prod-experience-oncall
        slack-message: |
          Benchmarks failed: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
