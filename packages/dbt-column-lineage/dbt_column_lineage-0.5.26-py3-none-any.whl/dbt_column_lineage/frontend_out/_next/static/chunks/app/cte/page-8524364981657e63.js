(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[318],{79826:function(e,t,s){Promise.resolve().then(s.bind(s,78878))},78878:function(e,t,s){"use strict";s.d(t,{Cte:function(){return S}});var l=s(57437),n=s(99376),r=s(96627),a=s(2265),o=s(97082),c=s(26554),i=s(54281);s(36556);var d=s(9965),u=s(38691),m=s(17756),h=s(60691),x=s(95230),f=s(34161),p=s.n(f),g=s(65504),b=s(91305),j=e=>{let{data:t}=e,s=(0,a.useCallback)((e,t,s)=>{e.stopPropagation();let l=t.schema,n=t.table,r=new URLSearchParams({schema:l,sources:n,activeSource:n});if(s){let e=JSON.stringify({[n]:[s]});r.set("selectedColumns",e)}window.open("/cte?".concat(r.toString()),"_blank")},[]);return(0,a.useEffect)(()=>{},[]),(0,l.jsxs)("div",{className:"relative bg-white border border-gray-300 rounded-md p-1 shadow-sm w-48 min-h-[60px] flex flex-col",children:[(0,l.jsx)(o.HH,{type:"target",position:o.Ly.Top,className:"opacity-0"}),(0,l.jsxs)("div",{className:"flex flex-col flex-grow",children:[(0,l.jsx)("div",{className:"font-semibold text-[11px] truncate mb-0.5",title:t.label,children:t.label}),(0,l.jsx)("div",{className:"flex-grow overflow-hidden",children:t.meta&&0!==t.meta.length?t.meta.map((e,t)=>(0,l.jsxs)("div",{className:"text-[9px] leading-tight font-mono whitespace-pre",children:[(0,l.jsx)("div",{className:"flex min-w-0",children:(0,l.jsx)("span",{className:"bg-amber-200 truncate",title:e.column,children:e.column})}),e.nextColumns.length>0?e.nextColumns.map((t,n)=>(0,l.jsxs)(a.Fragment,{children:[(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:n===e.nextColumns.length-1?"└── ":"├── "}),(0,l.jsx)("span",{className:"bg-emerald-200 truncate",title:t,children:t})]}),e.nextSources[n]&&(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 ".concat(n===e.nextColumns.length-1?"w-4":"w-1 mr-3"),children:n===e.nextColumns.length-1?"":"│"}),(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:"└── "}),(0,l.jsx)("span",{className:"bg-indigo-200 text-blue-700 truncate cursor-pointer underline",onClick:t=>s(t,e.nextSources[n],e.nextColumns[n]||e.column),title:e.nextSources[n].table,children:e.nextSources[n].table})]})]},n)):e.nextSources.map((t,n)=>(0,l.jsxs)("div",{className:"flex items-center",children:[(0,l.jsx)("span",{className:"flex-shrink-0 w-4",children:n===e.nextSources.length-1?"└── ":"├── "}),(0,l.jsx)("span",{className:"bg-indigo-200 text-blue-700 truncate cursor-pointer underline",onClick:l=>s(l,t,e.nextColumns[n]||e.column),title:t.table,children:t.table})]},n))]},t)):null})]}),(0,l.jsx)("div",{className:"flex flex-wrap gap-0.5 mt-1",children:[{key:"groups",color:"bg-pink-500",label:"group by"},{key:"havings",color:"bg-orange-500",label:"having"},{key:"wheres",color:"bg-red-500",label:"where"},{key:"unions",color:"bg-purple-500",label:"union"},{key:"joins",color:"bg-lime-500",label:"join"}].map(e=>{let{key:s,color:n,label:r}=e,a=t[s];return Array.isArray(a)&&a.length>0?(0,l.jsxs)("div",{className:"flex items-center cursor-pointer",title:a.join("\n"),children:[(0,l.jsx)("div",{className:"w-2 h-2 ".concat(n," mr-0.5 rounded-full")}),(0,l.jsx)("span",{className:"text-[6px]",children:r})]},s):null})}),(0,l.jsx)(o.HH,{type:"source",position:o.Ly.Bottom,className:"opacity-0"})]})},w=s(93448);let v=m.tk.theme({".cm-content":{fontFamily:"Roboto !important",fontSize:"smaller"}}),N=m.Py.define(),k=m.QQ.define({create:()=>m.p.none,update(e,t){for(let s of(e=e.map(t.changes),t.effects))s.is(N)&&(e=e.update({add:s.value,sort:!0}));return e},provide:e=>m.tk.decorations.from(e)}),y=(e,t,s)=>{let l=new(p()).graphlib.Graph;l.setDefaultEdgeLabel(()=>({})),l.setGraph({rankdir:s.rankdir,ranksep:30,nodesep:30}),t.forEach(e=>l.setEdge(e.source,e.target)),e.forEach(e=>l.setNode(e.id,{label:e.id,width:e.width,height:e.height})),p().layout(l);let n={};return t.forEach(t=>{n[t.source]||(n[t.source]=[]),n[t.source].push(e.find(e=>e.id===t.target))}),{nodes:e.map(e=>{let t=l.node(e.id),s=0;return Object.values(n).forEach(t=>{t.some(t=>t.id===e.id)&&(s=(t.findIndex(t=>t.id===e.id)-(t.length-1)/2)*100)}),{...e,position:{x:t.x-t.width/2+s,y:t.y-t.height/2}}}),edges:t}},C=e=>{let{nodes:t,edges:s,setNodes:r,setEdges:d,nodesPositioned:x,setNodesPositioned:f,codeMirrorRef:p,entireMeta:g}=e,b=(0,a.useRef)(!0),{fitView:w}=(0,o._K)(),v=(0,n.useSearchParams)(),[k,C]=(0,a.useState)(!1),S=(0,u.o)(e=>e.options),E=(0,u.o)(e=>e.setOptions),P=(0,a.useCallback)(e=>{if(null==p.current||null==p.current.view)return;let t=p.current.view,s=F(t,"".concat(e.data.label," as ("));s&&(null==t||t.dispatch({selection:{head:s[0].from,anchor:s[0].to},scrollIntoView:!0,effects:m.tk.scrollIntoView(s[0].from,{x:"start",y:"start"})}))},[v]),_=(0,a.useCallback)(()=>{if(0==t.length||x)return;let e=y(t,s,S);r([...e.nodes]),d([...e.edges]),window.requestAnimationFrame(()=>{setTimeout(()=>w(),0)}),C(!0),f(!0)},[x]),R=(0,a.useCallback)(e=>r(t=>(0,o.Fb)(e,t)),[r]),T=(0,a.useCallback)(e=>d(t=>(0,o.yn)(e,t)),[d]),A=(0,a.useCallback)(e=>d(t=>(0,o.Z_)(e,t)),[d]),F=(0,a.useCallback)((e,t)=>{let s=new h.FH(e.state.doc,t),l=[];for(let e=s.next();!e.done;e=s.next())l.push({from:e.value.from,to:e.value.to});return l},[]),L=(0,a.useCallback)((e,t,s,l)=>{let n=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),r=new h.Zg(e.state.doc,"\\b".concat(n,"\\b"),{},s,l),a=[];for(;!r.next().done;)a.push({from:r.value.from,to:r.value.to});return a},[]),O=(0,a.useCallback)(()=>{if(0==t.length||x||null==p.current||null==p.current.view||!Array.isArray(g))return;let e=m.p.mark({class:"bg-amber-200"}),s=m.p.mark({class:"bg-emerald-200"}),l=m.p.mark({class:"bg-indigo-200"}),n=[],r=[],a=[],o=null;for(let t of g){let c;let i=t.column,d=t.nextColumns,u=t.nextSources,m=t.reference,h="".concat(m," as ("),x=F(p.current.view,h),f=x.length>0?x[0].from:0;if(o){let e=F(p.current.view,o);c=e.length>0?e[0].from:void 0}for(let t of L(p.current.view,i,f,c))n.push(e.range(t.from,t.to));for(let e of d)for(let t of L(p.current.view,e,f,c))r.push(s.range(t.from,t.to));for(let e of u)for(let t of L(p.current.view,e.table,f,c))a.push(l.range(t.from,t.to));o=h}p.current.view.dispatch({effects:N.of(n)}),p.current.view.dispatch({effects:N.of(r)}),p.current.view.dispatch({effects:N.of(a)})},[g,x,p.current]),Z=(0,a.useMemo)(()=>({cte:e=>(0,l.jsx)(j,{...e})}),[]);return(0,a.useEffect)(()=>{O()},[x,p.current]),(0,a.useEffect)(()=>{b.current||_()},[x]),(0,a.useEffect)(()=>{E({rankdir:"TB"}),b.current=!1},[]),(0,l.jsx)(a.Suspense,{children:(0,l.jsxs)(o.x$,{minZoom:.2,nodes:t,nodeTypes:Z,edges:s,onNodesChange:R,onEdgesChange:T,onConnect:A,onNodeClick:(e,t)=>P(t),children:[(0,l.jsx)(c.Z,{}),(0,l.jsx)(i.A,{style:{backgroundColor:"#f5f5f5"}})]})})},S=()=>{let e=(0,r.Y)().height-55-32,[t,s]=(0,o.Rr)([]),[c,i]=(0,o.ll)([]),[h,f]=(0,a.useState)(!0),p=(0,a.useRef)(null),[j,N]=(0,a.useState)("lineage"),[y,S]=(0,a.useState)(""),[E,P]=(0,a.useState)(""),[_,R]=(0,a.useState)(""),[T,A]=(0,a.useState)(""),[F,L]=(0,a.useState)([]),[O,Z]=(0,a.useState)([]),H=(0,n.useRouter)(),M=(0,u.o)(e=>e.setMessage),U=(0,a.useCallback)(async e=>{let{sources:t,columns:l}=e;s([]),i([]);let n=t[0],r=l[n]?l[n][0]:"",a=new URLSearchParams({source:n,column:r}),o=await fetch("".concat("","/api/v1/cte?").concat(a)),c=await o.json();return 200!=o.status?(M(c.detail,"error"),setTimeout(()=>M(null,null),3e3),!1):(s(c.nodes),i(c.edges),S(c.tableName),P(c.materialized),R(c.query),A(c.description),L(c.columns),Z(c.entireMeta),setTimeout(()=>f(!1),100),z(),!0)},[H]),z=(0,a.useCallback)(()=>{N("lineage"),setTimeout(()=>f(!1),100)},[N,f]);return(0,l.jsxs)("div",{children:[(0,l.jsx)(d.h,{handleFetchData:U}),(0,l.jsxs)("div",{className:"flex flex-wrap",children:[(0,l.jsxs)("div",{className:"w-1/2",children:[(0,l.jsxs)("h4",{className:"h-[32px] px-1 text-2xl font-bold flex items-center",children:[(0,l.jsx)("span",{className:"select-text truncate",title:y,children:y}),(0,l.jsx)("span",{className:"ms-2 text-sm font-semibold text-gray-500 dark:text-gray-400 select-text ".concat((0,w.C)(E)," bg-opacity-50 rounded px-2 py-1"),children:E})]}),(0,l.jsx)("div",{className:"px-2",style:{height:e,overflowY:"auto"},children:(0,l.jsx)(m.ZP,{ref:p,value:_,theme:v,extensions:[(0,x.i6)(),k]})})]}),(0,l.jsxs)("div",{className:"w-1/2",children:[(0,l.jsx)("div",{className:"flex h-8 rounded-md p-0.5",children:["description","columns","lineage"].map(e=>(0,l.jsx)("button",{className:"".concat(j===e?"bg-white text-blue-600 shadow-sm":"text-gray-600 hover:bg-white/[0.12] hover:text-gray-900"," rounded-md px-2 text-xs font-medium transition-all duration-200 flex items-center justify-center h-7"),onClick:()=>"lineage"===e?z():N(e),children:e.charAt(0).toUpperCase()+e.slice(1)},e))}),(0,l.jsxs)("div",{style:{height:e,overflowY:"auto"},children:["description"==j&&(0,l.jsx)(g.U,{className:"markdown",remarkPlugins:[b.Z],children:T}),"columns"==j&&(e=>{let{columns:t}=e;return(0,l.jsxs)("table",{className:"table-auto text-xs w-full",children:[(0,l.jsx)("thead",{className:"sticky top-0 z-10",children:(0,l.jsxs)("tr",{className:"bg-gray-200",children:[(0,l.jsx)("th",{className:"border",children:"Column"}),(0,l.jsx)("th",{className:"border",children:"Type"}),(0,l.jsx)("th",{className:"border",children:"Description"})]})}),(0,l.jsx)("tbody",{children:Object.keys(t).map((e,s)=>(0,l.jsxs)("tr",{children:[(0,l.jsx)("td",{className:"border",children:t[e].name.toLowerCase()}),(0,l.jsx)("td",{className:"border",children:t[e].type}),(0,l.jsx)("td",{className:"border",children:t[e].comment})]},s))})]})})({columns:F}),"lineage"==j&&(0,l.jsx)(o.tV,{children:(0,l.jsx)(C,{nodes:t,edges:c,setNodes:s,setEdges:i,codeMirrorRef:p,nodesPositioned:h,setNodesPositioned:f,entireMeta:O})})]})]})]})]})}}},function(e){e.O(0,[627,780,401,563,11,496,971,117,744],function(){return e(e.s=79826)}),_N_E=e.O()}]);