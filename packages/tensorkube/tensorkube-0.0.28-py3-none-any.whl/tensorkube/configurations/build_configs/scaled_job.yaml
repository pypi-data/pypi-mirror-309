apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: JOB_NAME
  namespace: keda
spec:
  jobTargetRef:
    template:
      spec:
        serviceAccountName: keda-operator
        containers:
          - name: sqs-job-1
            image: JOB_IMAGE
            command: ["COMMAND", "ARGS"]
            env:
              - name: AWS_REGION
                value: us-east-1
              - name: QUEUE_URL
                value: <QUEUE_URL>
              - name: JOB_NAME
                value: <JOB_NAME>
            volumeMounts:
              - name: efs-storage
                mountPath: /mnt/efs
              - name: local-mount
                mountPath: /mnt/local
            securityContext:
              runAsUser: 0
              capabilities:
                add:
                  - SYS_ADMIN
        restartPolicy: Never
        volumes:
          - name: efs-storage
            persistentVolumeClaim:
              claimName: efs-pvc
          - name: local-mount
            emptyDir: { }
  pollingInterval: 90        # Check the queue every 10 seconds
  maxReplicaCount: 2        # Max number of concurrent jobs
  successfulJobsHistoryLimit: 3   # Optional. Default: 100. How many completed jobs should be kept.
  failedJobsHistoryLimit: 2
  scalingStrategy:
    strategy: "accurate"  # Scaling strategy to use

  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: QUEUE_URL
        queueLength: "1"        # Scale up when there are 1 messages in the queue
        awsRegion: "us-east-1"
        scaleOnInFlight: "false"
      authenticationRef:
        name: aws-sqs-auth
